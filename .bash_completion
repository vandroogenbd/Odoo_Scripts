#!/bin/bash

_branches() {
    local cur branches repo_path
    cur="${COMP_WORDS[COMP_CWORD]}"          # Current word being typed
    repo_path="$HOME/work/community-master"  # Path to the master repository

    branches=$(git -C ${repo_path} for-each-ref refs/heads/ --format="%(refname:short)")

    COMPREPLY=( $(compgen -W "${branches}" -- "${cur}") )
}

complete -F _branches close

_modules(){
      if [ ${COMP_WORDS[COMP_CWORD-1]} != "-i" ]
      then
          return 0
      fi
      local cur branch modules
      cur=${COMP_WORDS[COMP_CWORD]}
      branch=$(echo $(pwd) | awk -F/ '{print $NF}' | cut -d '_' -f 2-)
      community_addons=$(find "$HOME/work/community_$branch/addons" -maxdepth 1 -type d -exec basename {} \; 2>/dev/null)
      enterprise_addons=$(find "$HOME/work/enterprise_$branch" -maxdepth 1 -type d -exec basename {} \; 2>/dev/null)
      modules="${community_addons} ${enterprise_addons}"
      COMPREPLY=( $(compgen -W "${modules}" -- "${cur}") )
}

complete -F _modules odoo
